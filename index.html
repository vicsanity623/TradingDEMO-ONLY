<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Geo Horror GO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a0f">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;height:100%;background:#000;font-family:system-ui;overflow:hidden}
#map{height:100%}
.hud{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,15,.95);display:flex;justify-content:space-between;padding:10px;z-index:1000}
button{background:#1c1c28;border:1px solid #333;color:#fff;border-radius:12px;padding:10px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;flex-direction:column;color:#fff;z-index:2000}
.modal.active{display:flex}
header{padding:12px;font-size:18px;border-bottom:1px solid #333}
.modal-content{flex:1;overflow:auto;padding:12px}
.monster-card{display:flex;gap:12px;background:#141420;padding:10px;border-radius:12px;margin-bottom:10px}
.monster-card img{width:64px;filter:contrast(1.3) brightness(.8)}
.hp-bar{height:6px;background:#300;border-radius:4px;overflow:hidden}
.hp-fill{height:100%;background:red;transition:width .2s}
.log{font-size:13px;white-space:pre-line}
.spin{animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="map"></div>

<div class="hud">
<button onclick="createGym()">Create GYM</button>
<div id="status"></div>
<button onclick="openRoster()">Inventory</button>
</div>

<div class="modal" id="rosterModal">
<header>Collection <button onclick="closeAll()">Close</button></header>
<div class="modal-content" id="rosterList"></div>
</div>

<script>
/* =========================
   STATE
========================= */
const state = JSON.parse(localStorage.getItem('state')) || {
    xp: 0,
    balls: 25,
    coins: 0,
    monsters: [],
    gyms: [],
    path: {}
};

let map;
let pathLine;

/* =========================
   SAFE MAP INIT (ONCE)
========================= */
window.addEventListener('load', () => {
    map = L.map('map', { zoomControl:false }).setView([0,0],18);

    L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { maxZoom: 20 }
    ).addTo(map);

    startGPS();
    drawGyms();
    updateHUD();
});

/* =========================
   GPS
========================= */
function startGPS(){
    navigator.geolocation.watchPosition(p=>{
        const latlng=[p.coords.latitude,p.coords.longitude];
        map.setView(latlng);
        recordPath(latlng);

        if(Math.random() > 0.99) spawnSpin(latlng);
    },err=>{
        alert("GPS required");
    },{enableHighAccuracy:true});
}

/* =========================
   PATH TRACKING
========================= */
function recordPath(p){
    const key=p.map(v=>v.toFixed(5)).join(',');
    state.path[key]=(state.path[key]||0)+1;

    if(pathLine) map.removeLayer(pathLine);

    const points = Object.keys(state.path).map(k=>k.split(',').map(Number));
    const hue = Math.min(state.path[key]*15,360);

    pathLine = L.polyline(points,{
        color:`hsl(${hue},80%,50%)`,
        weight:6
    }).addTo(map);

    save();
}

/* =========================
   SPIN STOPS
========================= */
function spawnSpin(p){
    const m = L.marker(p,{
        icon:L.divIcon({html:'ðŸŒ€',className:'spin'})
    }).addTo(map);

    m.on('click',()=>{
        Math.random()<0.5 ? state.balls++ : state.coins+=10;
        map.removeLayer(m);
        save();
    });
}

/* =========================
   GYMS
========================= */
function createGym(){
    if(state.gyms.length>=3) return;
    navigator.geolocation.getCurrentPosition(p=>{
        state.gyms.push({
            lat:p.coords.latitude,
            lng:p.coords.longitude
        });
        drawGyms();
        save();
    });
}

function drawGyms(){
    state.gyms.forEach(g=>{
        L.circle([g.lat,g.lng],{
            radius:25,
            color:'red',
            fillOpacity:0.3
        }).addTo(map);
    });
}

/* =========================
   ROSTER
========================= */
function openRoster(){
    const list=document.getElementById('rosterList');
    list.innerHTML='';
    state.monsters.forEach(m=>{
        const d=document.createElement('div');
        d.className='monster-card';
        d.innerHTML=`
        <img src="${sprite(m.id)}">
        <div>
        <b>${m.name||'Feral Beast'}</b><br>
        HP ${m.hp||100}/${m.maxHp||100}
        </div>`;
        list.appendChild(d);
    });
    show('rosterModal');
}

function sprite(id){
    return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
}

/* =========================
   UI
========================= */
function show(id){
    document.getElementById(id).classList.add('active');
}
function closeAll(){
    document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'));
}
function updateHUD(){
    document.getElementById('status').textContent =
        `XP:${state.xp} Balls:${state.balls} Coins:${state.coins}`;
}
function save(){
    localStorage.setItem('state',JSON.stringify(state));
    updateHUD();
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS | Speed Trader</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 950: '#0b0e11', 900: '#151a1e', 800: '#1e2329', 700: '#2b3139', 600: '#474d57' },
                        trade: { buy: '#0ecb81', sell: '#f6465d', accent: '#fcd535', fire: '#ff9f43', clock: '#3b82f6' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0b0e11; color: #eaecef; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .number-font { font-family: 'Roboto Mono', monospace; }
        
        .loader { border: 2px solid #1e2329; border-top: 2px solid #fcd535; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0b0e11; }
        ::-webkit-scrollbar-thumb { background: #2b3139; border-radius: 2px; }

        .flash-green { animation: flashG 0.6s; }
        .flash-red { animation: flashR 0.6s; }
        @keyframes flashG { 0% { color: #0ecb81; background-color: rgba(14, 203, 129, 0.2); } 100% { color: inherit; background-color: transparent; } }
        @keyframes flashR { 0% { color: #f6465d; background-color: rgba(246, 70, 93, 0.2); } 100% { color: inherit; background-color: transparent; } }

        /* Streak Effects */
        .streak-step { position: relative; padding-left: 20px; }
        .streak-step::before { content: ''; position: absolute; left: 7px; top: 0; bottom: 0; width: 2px; background: #2b3139; }
        .streak-step.active::before { background: #fcd535; }
        .streak-dot { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; border-radius: 50%; background: #1e2329; border: 2px solid #474d57; z-index: 2; }
        .streak-step.active .streak-dot { background: #fcd535; border-color: #fcd535; box-shadow: 0 0 10px #fcd535; }
        .streak-step.completed .streak-dot { background: #0ecb81; border-color: #0ecb81; }

        /* Timer Bar */
        .timer-progress { transition: width 1s linear; }
    </style>
</head>
<body>

<div id="app" class="h-[100dvh] flex flex-col bg-dark-950 text-white overflow-hidden">

    <!-- 1. HEADER -->
    <header class="shrink-0 bg-dark-900 border-b border-dark-800 flex flex-col z-30">
        <div class="h-14 flex items-center justify-between px-3">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-layer-group text-trade-accent text-xl"></i>
                <div class="relative">
                    <button @click="toggleAssetMenu" class="flex items-center gap-2 font-bold text-lg leading-none hover:text-trade-accent transition">
                        {{ currentPair.replace('USD', '').toUpperCase() }}
                        <span class="text-xs text-gray-500 font-normal">/USD</span>
                        <i class="fa-solid fa-caret-down text-xs"></i>
                    </button>
                    <div v-if="assetMenuOpen" class="absolute top-full left-0 mt-3 w-48 bg-dark-800 rounded-lg shadow-2xl border border-dark-700 overflow-hidden z-50">
                        <div v-for="pair in availablePairs" :key="pair" @click="changePair(pair)" class="px-4 py-3 hover:bg-dark-700 cursor-pointer border-b border-dark-700 last:border-0 flex justify-between">
                            <span class="font-bold">{{ pair.replace('USD', '').toUpperCase() }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col items-end">
                <span class="text-lg number-font font-bold tracking-tight" :class="priceColor">
                    {{ formatPrice(currentPrice) }}
                </span>
                <span class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Live US Data</span>
            </div>
        </div>
    </header>

    <!-- 2. MAIN CONTENT -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
        
        <!-- LEFT: CHART -->
        <main class="relative w-full h-[45vh] lg:h-full lg:flex-1 bg-dark-950 flex flex-col border-b lg:border-b-0 lg:border-r border-dark-800">
            <!-- Controls -->
            <div class="absolute top-3 left-3 z-10 flex gap-1 p-1 bg-dark-900 rounded border border-dark-700 shadow-lg">
                <button v-for="tf in chartTimeframes" :key="tf.val" 
                        @click="changeChartTimeframe(tf.val)"
                        :class="currentChartTimeframe === tf.val ? 'text-dark-950 bg-trade-accent font-bold' : 'text-gray-400 hover:text-white'"
                        class="px-2 py-1 text-[10px] rounded transition-colors">
                    {{ tf.label }}
                </button>
            </div>

            <!-- Loader / Error -->
            <div v-if="isLoading" class="absolute inset-0 z-0 flex items-center justify-center bg-dark-950 pointer-events-none">
                <div class="loader"></div>
            </div>
            
            <!-- Chart Container -->
            <div id="chart-container" class="w-full h-full"></div>
        </main>

        <!-- RIGHT: TRADING PANEL -->
        <aside class="w-full lg:w-[380px] bg-dark-900 flex flex-col shrink-0 relative z-20">
            
            <!-- Tabs -->
            <div class="flex border-b border-dark-800">
                <button @click="activeTab = 'trade'" :class="activeTab === 'trade' ? 'text-trade-accent border-trade-accent' : 'text-gray-500 border-transparent'" class="flex-1 py-3 text-sm font-bold border-b-2 bg-dark-900 hover:bg-dark-800">Trade</button>
                <button @click="activeTab = 'compound'" :class="activeTab === 'compound' ? 'text-trade-fire border-trade-fire' : 'text-gray-500 border-transparent'" class="flex-1 py-3 text-sm font-bold border-b-2 bg-dark-900 hover:bg-dark-800"><i class="fa-solid fa-fire mr-1"></i>Compound</button>
                <button @click="activeTab = 'positions'" :class="activeTab === 'positions' ? 'text-trade-accent border-trade-accent' : 'text-gray-500 border-transparent'" class="flex-1 py-3 text-sm font-bold border-b-2 bg-dark-900 hover:bg-dark-800">Pos ({{ positions.length }})</button>
            </div>

            <!-- TAB 1: TRADE -->
            <div v-show="activeTab === 'trade'" class="flex flex-col h-full overflow-y-auto">
                <div class="p-4 space-y-4">
                    <!-- Balance -->
                    <div class="flex justify-between items-end bg-dark-800 p-3 rounded border border-dark-700">
                        <div>
                            <div class="text-[10px] text-gray-400 uppercase">Total Equity</div>
                            <div class="text-xl font-bold text-white number-font">${{ formatMoney(equity) }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-400 uppercase">Available</div>
                            <div class="text-sm text-gray-300 number-font">${{ account ? formatMoney(account.balance) : '0.00' }}</div>
                        </div>
                    </div>

                    <!-- Notif -->
                    <div v-if="notification" class="bg-blue-600/20 border border-blue-500 text-blue-100 px-3 py-2 rounded text-xs flex items-center gap-2 animate-pulse">
                        <i class="fa-solid fa-circle-info"></i> {{ notification }}
                    </div>

                    <!-- Trade Duration Selector (NEW) -->
                    <div class="space-y-1">
                        <label class="text-[10px] text-gray-500 font-bold uppercase">Auto-Close Timer</label>
                        <div class="grid grid-cols-5 gap-1.5">
                            <button v-for="d in tradeDurations" :key="d.ms" 
                                    @click="selectedDuration = d"
                                    :class="selectedDuration.ms === d.ms ? 'bg-trade-clock text-white border-trade-clock' : 'bg-dark-800 text-gray-400 border-dark-700 hover:bg-dark-700'"
                                    class="text-[10px] py-1.5 rounded border transition-colors font-bold">
                                {{ d.label }}
                            </button>
                        </div>
                    </div>

                    <!-- Amount Input -->
                    <div class="bg-dark-950 rounded border border-dark-700 p-2 focus-within:border-trade-accent transition-colors">
                        <label class="text-[10px] text-gray-500 block mb-1">Order Value</label>
                        <div class="flex items-center">
                            <input type="number" v-model.number="orderAmount" class="bg-transparent w-full text-white font-bold text-lg outline-none number-font" placeholder="0.00">
                            <span class="text-xs text-gray-500 font-bold">USD</span>
                        </div>
                    </div>
                    
                    <!-- Percentages -->
                    <div class="grid grid-cols-4 gap-2">
                        <button v-for="pct in [10, 25, 50, 100]" @click="setAmount(pct)" class="bg-dark-800 text-[10px] py-2 rounded hover:bg-dark-700 text-gray-300 transition">{{ pct }}%</button>
                    </div>

                    <!-- Buttons -->
                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button @click="executeTrade('buy', false)" class="bg-trade-buy hover:brightness-110 text-white py-4 rounded font-bold shadow-lg active:scale-95 transition-all">
                            LONG
                            <div class="text-[9px] font-normal opacity-80">{{ selectedDuration.label }} Auto-Close</div>
                        </button>
                        <button @click="executeTrade('sell', false)" class="bg-trade-sell hover:brightness-110 text-white py-4 rounded font-bold shadow-lg active:scale-95 transition-all">
                            SHORT
                            <div class="text-[9px] font-normal opacity-80">{{ selectedDuration.label }} Auto-Close</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB 2: COMPOUND -->
            <div v-show="activeTab === 'compound'" class="flex flex-col h-full overflow-y-auto bg-dark-900 relative">
                <div v-if="!streak.active" class="p-6 flex flex-col items-center justify-center h-full text-center">
                    <div class="w-16 h-16 rounded-full bg-trade-fire/10 flex items-center justify-center mb-4 text-trade-fire text-3xl glow-gold">
                        <i class="fa-solid fa-fire"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">Compound Speed Run</h3>
                    <p class="text-sm text-gray-400 mb-6 px-4">Select a timer. Reinvest 100% of profits. Can you survive the streak?</p>
                    
                    <div class="w-full bg-dark-950 p-4 rounded-lg border border-dark-700 mb-6">
                        <label class="text-xs text-gray-500 mb-2 block text-left">Initial Risk Amount</label>
                        <div class="flex items-center gap-2">
                            <span class="text-trade-fire font-bold">$</span>
                            <input type="number" v-model.number="streak.initialInput" class="bg-transparent w-full text-white font-bold text-2xl outline-none number-font" placeholder="10">
                        </div>
                    </div>

                    <button @click="startStreak" class="w-full bg-gradient-to-r from-orange-500 to-trade-fire text-dark-950 font-bold py-4 rounded-lg shadow-lg hover:brightness-110 transition active:scale-95">
                        Start Streak
                    </button>
                </div>

                <div v-else class="flex flex-col h-full">
                    <div class="bg-gradient-to-b from-dark-800 to-dark-900 p-4 border-b border-dark-800">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-trade-fire uppercase tracking-widest">Step {{ streak.step }} Active</span>
                            <button @click="endStreak" class="text-[10px] text-gray-500 hover:text-white underline">Quit</button>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="text-gray-400 text-xs">Pot Size</div>
                                <div class="text-3xl font-bold text-white number-font">${{ formatMoney(streak.currentPot) }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-gray-400 text-xs">Timer</div>
                                <div class="text-sm text-trade-clock font-bold">{{ selectedDuration.label }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Simple Streak Visual -->
                    <div class="flex-1 p-6 flex flex-col items-center justify-center opacity-30">
                        <i class="fa-solid fa-layer-group text-6xl mb-4"></i>
                        <div class="text-center text-xs">Winning a streak trade adds profit to pot.<br>Losing resets to Step 1.</div>
                    </div>

                    <!-- Streak Action -->
                    <div class="p-4 bg-dark-950 border-t border-dark-800 z-10">
                        <!-- Duration Selector inside Streak -->
                        <div class="grid grid-cols-5 gap-1 mb-4">
                            <button v-for="d in tradeDurations" :key="d.ms" 
                                    @click="selectedDuration = d"
                                    :class="selectedDuration.ms === d.ms ? 'bg-trade-clock text-white border-trade-clock' : 'bg-dark-800 text-gray-500 border-dark-700'"
                                    class="text-[9px] py-1 rounded border font-bold">
                                {{ d.label }}
                            </button>
                        </div>

                        <div v-if="hasOpenStreakPos" class="text-center py-4 text-yellow-500 font-bold text-sm animate-pulse">
                            Trade Live...
                        </div>
                        <div v-else class="grid grid-cols-2 gap-3">
                            <button @click="executeTrade('buy', true)" class="bg-trade-buy hover:brightness-110 text-white py-4 rounded font-bold shadow-lg active:scale-95 transition-all">
                                Step Up (Long)
                            </button>
                            <button @click="executeTrade('sell', true)" class="bg-trade-sell hover:brightness-110 text-white py-4 rounded font-bold shadow-lg active:scale-95 transition-all">
                                Step Up (Short)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: POSITIONS (With Timers) -->
            <div v-show="activeTab === 'positions'" class="flex-1 bg-dark-900 flex flex-col overflow-hidden">
                <div class="overflow-auto flex-1 p-2">
                    <div v-if="positions.length === 0" class="h-full flex flex-col items-center justify-center text-gray-600 space-y-2">
                        <i class="fa-solid fa-hourglass-half text-3xl"></i>
                        <span class="text-xs">No active trades</span>
                    </div>

                    <div v-for="pos in positions" :key="pos.id" class="bg-dark-950 p-3 mb-2 rounded border border-dark-800 relative overflow-hidden">
                        
                        <!-- Timer Progress Bar -->
                        <div class="absolute bottom-0 left-0 h-1 bg-trade-clock timer-progress" :style="{ width: getProgress(pos) + '%' }"></div>
                        
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-2">
                                <span :class="pos.side === 'buy' ? 'text-trade-buy border-trade-buy' : 'text-trade-sell border-trade-sell'" class="text-[10px] px-1 rounded border uppercase font-bold">{{ pos.side }}</span>
                                <span class="text-sm font-bold">{{ pos.symbol }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- Countdown Display -->
                                <span class="text-xs font-mono font-bold text-trade-clock bg-blue-900/30 px-1 rounded">
                                    <i class="fa-regular fa-clock mr-1"></i>{{ getCountdown(pos) }}
                                </span>
                                <span :class="getPnl(pos) >= 0 ? 'text-trade-buy' : 'text-trade-sell'" class="font-bold number-font text-sm">
                                    ${{ getPnl(pos).toFixed(2) }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between text-[11px] text-gray-500">
                            <div>Entry: <span class="text-gray-300">{{ formatPrice(pos.entryPrice) }}</span></div>
                            <div>Current: <span class="text-gray-300">{{ formatPrice(currentPrice) }}</span></div>
                        </div>
                        
                        <!-- Early Close Button (Optional) -->
                        <button @click="closePosition(pos)" class="w-full mt-2 py-1 bg-dark-800 hover:bg-dark-700 text-[10px] text-gray-400 rounded">Close Early</button>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Login Modal -->
    <div v-if="showLogin" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-6">
        <div class="bg-dark-800 border border-dark-700 rounded-2xl p-8 w-full max-w-md shadow-2xl text-center">
            <h2 class="text-2xl font-bold text-white mb-2">NEXUS Speed Trader</h2>
            <p class="text-gray-400 text-sm mb-6">Demo account loaded with <b>$100,000</b>.</p>
            <button @click="createAccount" class="w-full bg-trade-accent hover:bg-yellow-400 text-dark-950 font-bold py-4 rounded-xl transition-all shadow-lg text-lg">Start Trading</button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, computed, watch } = Vue;

    createApp({
        setup() {
            // UI
            const activeTab = ref('trade');
            const assetMenuOpen = ref(false);
            const isLoading = ref(true);
            const showLogin = ref(false);
            const notification = ref('');
            
            // Trade Durations
            const tradeDurations = [
                { label: '30s', ms: 30000 },
                { label: '1m', ms: 60000 },
                { label: '2m', ms: 120000 },
                { label: '5m', ms: 300000 },
                { label: '10m', ms: 600000 },
                { label: '15m', ms: 900000 },
                { label: '30m', ms: 1800000 },
                { label: '1h', ms: 3600000 },
                { label: '4h', ms: 14400000 },
            ];
            const selectedDuration = ref(tradeDurations[1]); // Default 1m

            // Data
            const availablePairs = ['BTCUSD', 'ETHUSD', 'SOLUSD', 'DOGEUSD'];
            const currentPair = ref('BTCUSD');
            const currentPrice = ref(0);
            
            // Chart Timeframes
            const chartTimeframes = [
                { label: '1m', val: '1m' }, { label: '5m', val: '5m' },
                { label: '15m', val: '15m' }, { label: '1h', val: '1h' }
            ];
            const currentChartTimeframe = ref('1m'); // Default 1m for speed trading

            // State
            const account = ref(null);
            const orderAmount = ref('');
            const positions = ref([]);
            const streak = ref({ active: false, initialInput: 10, initialRisk: 0, currentPot: 0, step: 1 });

            // Internals
            let ws = null;
            let chart = null;
            let candleSeries = null;
            let timerInterval = null; // For checking expirations

            const equity = computed(() => {
                if(!account.value) return 0;
                let unrealized = 0;
                positions.value.forEach(p => unrealized += getPnl(p));
                return account.value.balance + unrealized;
            });

            const hasOpenStreakPos = computed(() => positions.value.some(p => p.isStreak));

            // Auto-Reset on Bankruptcy
            watch(equity, (val) => {
                if(account.value && val < 5) {
                    account.value.balance = 100000;
                    positions.value = [];
                    streak.value.active = false;
                    notification.value = "Account Reset!";
                    saveData();
                }
            });

            onMounted(() => {
                const saved = localStorage.getItem('nexus_speed');
                if(saved) {
                    const data = JSON.parse(saved);
                    account.value = data.account;
                    positions.value = data.positions || [];
                    if(data.streak) streak.value = data.streak;
                } else {
                    showLogin.value = true;
                }
                initChart();
                connectWebSocket();
                fetchHistory();

                // Start the Global Timer Loop (Checks every 500ms)
                timerInterval = setInterval(() => {
                    checkExpiries();
                    // Force UI update for countdowns
                    positions.value = [...positions.value]; 
                }, 500);
            });

            // --- AUTO CLOSE LOGIC ---
            const checkExpiries = () => {
                const now = Date.now();
                positions.value.forEach(pos => {
                    if (pos.expiryTime && now >= pos.expiryTime) {
                        closePosition(pos, true); // True = auto closed
                    }
                });
            };

            const getCountdown = (pos) => {
                const left = Math.max(0, pos.expiryTime - Date.now());
                const secs = Math.floor((left / 1000) % 60);
                const mins = Math.floor((left / 1000 / 60) % 60);
                const hrs = Math.floor((left / 1000 / 60 / 60));
                
                if(hrs > 0) return `${hrs}h ${mins}m`;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const getProgress = (pos) => {
                const total = pos.expiryTime - pos.startTime;
                const elapsed = Date.now() - pos.startTime;
                const pct = Math.max(0, Math.min(100, (elapsed / total) * 100));
                return 100 - pct; // Inverted for countdown effect
            };

            // --- TRADING ---
            const createAccount = () => {
                account.value = { name: 'Trader', balance: 100000 };
                positions.value = [];
                saveData();
                showLogin.value = false;
            };

            const setAmount = (pct) => {
                if(!account.value) return;
                orderAmount.value = Math.floor(account.value.balance * (pct/100));
            };

            const executeTrade = (side, isStreak) => {
                let amt = isStreak ? streak.value.currentPot : orderAmount.value;
                if(!amt || amt <= 0 || amt > account.value.balance) return;
                if(isStreak && hasOpenStreakPos.value) return;

                account.value.balance -= amt;
                const now = Date.now();

                positions.value.unshift({
                    id: now,
                    symbol: currentPair.value.replace('USD',''),
                    side: side,
                    qty: amt / currentPrice.value,
                    entryPrice: currentPrice.value,
                    collateral: amt,
                    isStreak: isStreak,
                    startTime: now,
                    expiryTime: now + selectedDuration.value.ms, // Set Expiry
                    durationLabel: selectedDuration.value.label
                });
                
                if(!isStreak) orderAmount.value = '';
                saveData();
                if(window.innerWidth < 1024) activeTab.value = 'positions';
            };

            const closePosition = (pos, auto = false) => {
                const pnl = getPnl(pos);
                const totalReturn = pos.collateral + pnl;
                account.value.balance += totalReturn;

                if(pos.isStreak) {
                    if(pnl > 0) {
                        streak.value.currentPot = totalReturn;
                        streak.value.step++;
                        notification.value = "Streak Won!";
                    } else {
                        streak.value.active = false;
                        notification.value = "Streak Reset.";
                    }
                } else if (auto) {
                    notification.value = `Trade Auto-Closed (${pos.durationLabel})`;
                    setTimeout(() => notification.value = '', 3000);
                }

                positions.value = positions.value.filter(p => p.id !== pos.id);
                saveData();
            };

            // --- DATA ---
            const initChart = () => {
                const container = document.getElementById('chart-container');
                chart = LightweightCharts.createChart(container, {
                    layout: { background: { type: 'solid', color: '#0b0e11' }, textColor: '#6b7280' },
                    grid: { vertLines: { color: '#151a1e' }, horzLines: { color: '#151a1e' } },
                    timeScale: { timeVisible: true, secondsVisible: true, borderColor: '#1e2329' },
                });
                candleSeries = chart.addCandlestickSeries({ upColor: '#0ecb81', downColor: '#f6465d' });
                new ResizeObserver(e => {
                   if(e.length) chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height });
                }).observe(container);
            };

            const fetchHistory = async () => {
                try {
                    isLoading.value = true;
                    const res = await fetch(`https://api.binance.us/api/v3/klines?symbol=${currentPair.value}&interval=${currentChartTimeframe.value}&limit=300`);
                    const data = await res.json();
                    candleSeries.setData(data.map(d => ({ time: d[0]/1000, open: +d[1], high: +d[2], low: +d[3], close: +d[4] })));
                } catch(e) { console.log("History error, using live build"); }
                isLoading.value = false;
            };

            const connectWebSocket = () => {
                if(ws) ws.close();
                ws = new WebSocket(`wss://stream.binance.us:9443/ws/${currentPair.value.toLowerCase()}@kline_${currentChartTimeframe.value}`);
                ws.onmessage = (e) => {
                    const k = JSON.parse(e.data).k;
                    candleSeries.update({ time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c });
                    currentPrice.value = +k.c;
                };
            };

            // --- UTILS ---
            const changePair = (p) => { currentPair.value = p; assetMenuOpen.value = false; connectWebSocket(); fetchHistory(); };
            const changeChartTimeframe = (tf) => { currentChartTimeframe.value = tf; connectWebSocket(); fetchHistory(); };
            const toggleAssetMenu = () => assetMenuOpen.value = !assetMenuOpen.value;
            const getPnl = (pos) => (currentPrice.value - pos.entryPrice) * pos.qty * (pos.side === 'buy' ? 1 : -1);
            const startStreak = () => { streak.value = { active: true, initialInput: streak.value.initialInput, initialRisk: streak.value.initialInput, currentPot: streak.value.initialInput, step: 1 }; saveData(); };
            const endStreak = () => { streak.value.active = false; saveData(); };
            const formatMoney = (v) => v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const formatPrice = (v) => v < 10 ? v.toFixed(4) : v.toFixed(2);
            const saveData = () => localStorage.setItem('nexus_speed', JSON.stringify({ account: account.value, positions: positions.value, streak: streak.value }));

            return {
                activeTab, assetMenuOpen, isLoading, showLogin, notification,
                tradeDurations, selectedDuration, chartTimeframes, currentChartTimeframe,
                availablePairs, currentPair, currentPrice, account, orderAmount, positions, streak, hasOpenStreakPos, equity,
                createAccount, setAmount, executeTrade, closePosition,
                changePair, changeChartTimeframe, toggleAssetMenu, getPnl, formatMoney, formatPrice,
                startStreak, endStreak, getCountdown, getProgress
            };
        }
    }).mount('#app');
</script>
</body>
</html>
